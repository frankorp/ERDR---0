{% extends "base.html" %}

{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è - {{ get_agency_data(agency).name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <div class="user-info">
            <div>
                <h1>{{ get_agency_data(agency).name }} - –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</h1>
                <p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á: {{ user.name }} ({{ user.position }})</p>
            </div>
            <div>
                <button class="btn btn-danger" onclick="logout()">–í–∏–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_cases }}</div>
            <div>–í—Å—å–æ–≥–æ —Å–ø—Ä–∞–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_cases }}</div>
            <div>–ê–∫—Ç–∏–≤–Ω–∏—Ö —Å–ø—Ä–∞–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ critical_cases }}</div>
            <div>–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö —Å–ø—Ä–∞–≤</div>
        </div>
        {% if agency == 'admin' %}
        <div class="stat-card">
            <div class="stat-number">{{ SYSTEM_LOGS.logs|length }}</div>
            <div>–°–∏—Å—Ç–µ–º–Ω–∏—Ö –ª–æ–≥—ñ–≤</div>
        </div>
        {% endif %}
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>–°–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤</h2>
        <button class="btn btn-success" onclick="showAddCaseModal()">‚ûï –î–æ–¥–∞—Ç–∏ —Å–ø—Ä–∞–≤—É</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏</th>
                <th>–ù–∞–∑–≤–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</th>
                <th>–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π</th>
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody>
            {% for case in cases %}
            <tr>
                <td>{{ case.number }}</td>
                <td>{{ case.title }}</td>
                <td>
                    <span class="badge 
                        {% if case.status == 'new' %}badge-primary
                        {% elif case.status == 'in-progress' %}badge-warning
                        {% elif case.status == 'completed' %}badge-success
                        {% else %}badge-danger{% endif %}">
                        {{ get_status_text(case.status) }}
                    </span>
                </td>
                <td>{{ case.createdDate }}</td>
                <td>{{ case.responsible }}</td>
                <td>
                    <button class="btn btn-primary" onclick="viewCase({{ case.id }})">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥</button>
                    {% if agency == 'prosecutor' %}
                    <button class="btn btn-danger" onclick="requestCaseDeletion({{ case.id }})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    {% else %}
                    <button class="btn" disabled title="–¢—ñ–ª—å–∫–∏ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ –º–æ–∂–µ –≤–∏–¥–∞–ª—è—Ç–∏ —Å–ø—Ä–∞–≤–∏">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if agency == 'admin' %}
    <div style="margin-top: 40px;">
        <h2>–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞ –ø–∞–Ω–µ–ª—å</h2>
        <div class="filters">
            <div class="filter-group">
                <label>–¢–∏–ø –ª–æ–≥—É:</label>
                <select onchange="filterLogs('type', this.value)">
                    <option value="">–í—Å—ñ —Ç–∏–ø–∏</option>
                    <option value="login">–í—Ö—ñ–¥</option>
                    <option value="logout">–í–∏—Ö—ñ–¥</option>
                    <option value="create">–°—Ç–≤–æ—Ä–µ–Ω–Ω—è</option>
                    <option value="delete">–í–∏–¥–∞–ª–µ–Ω–Ω—è</option>
                    <option value="view">–ü–µ—Ä–µ–≥–ª—è–¥</option>
                    <option value="system">–°–∏—Å—Ç–µ–º–∞</option>
                </select>
            </div>
            <button class="btn btn-warning" onclick="exportAllLogs()">üìä –ï–∫—Å–ø–æ—Ä—Ç –ª–æ–≥—ñ–≤</button>
        </div>
        
        <div id="logs-container">
            {% for log in SYSTEM_LOGS.logs[:50] %}
            <div class="log-item log-type-{{ log.type }}">
                <div class="log-info">
                    <div><strong>{{ log.action }}</strong></div>
                    <div>{{ log.details|tojson }}</div>
                    <div>
                        üë§ {{ log.user }} | 
                        üè¢ {{ log.agency }} | 
                        üåê {{ log.ip }} | 
                        üïí {{ log.timestamp }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ–ª–∞ -->
<div class="modal" id="addCaseModal">
    <div class="modal-content">
        <h2>–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É —Å–ø—Ä–∞–≤—É</h2>
        
        <div class="form-group">
            <label for="caseNumber">–ù–æ–º–µ—Ä —Å–ø—Ä–∞–≤–∏:</label>
            <input type="text" id="caseNumber" class="form-control" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: 210/2024">
        </div>
        
        <div class="form-group">
            <label for="caseTitle">–ù–∞–∑–≤–∞ —Å–ø—Ä–∞–≤–∏:</label>
            <input type="text" id="caseTitle" class="form-control" placeholder="–ö–æ—Ä–æ—Ç–∫–∞ –Ω–∞–∑–≤–∞ —Å–ø—Ä–∞–≤–∏">
        </div>
        
        <div class="form-group">
            <label for="caseDescription">–û–ø–∏—Å:</label>
            <textarea id="caseDescription" class="form-control" rows="3" placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å —Å–ø—Ä–∞–≤–∏"></textarea>
        </div>
        
        <div class="form-group">
            <label for="caseCategory">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="caseCategory" class="form-control">
                <option value="criminal">–ö—Ä–∏–º—ñ–Ω–∞–ª—å–Ω–∞</option>
                <option value="operational">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞</option>
                <option value="supervision">–ù–∞–≥–ª—è–¥</option>
                <option value="administrative">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="casePriority">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:</label>
            <select id="casePriority" class="form-control">
                <option value="low">–ù–∏–∑—å–∫–∏–π</option>
                <option value="medium" selected>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                <option value="high">–í–∏—Å–æ–∫–∏–π</option>
                <option value="critical">–ö—Ä–∏—Ç–∏—á–Ω–∏–π</option>
            </select>
        </div>
        
        <button class="btn btn-success" onclick="addNewCase()" style="width: 100%; margin-bottom: 10px;">–°—Ç–≤–æ—Ä–∏—Ç–∏ —Å–ø—Ä–∞–≤—É</button>
        <button class="btn" onclick="closeAddCaseModal()" style="width: 100%; background: var(--gray);">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä—ã) -->
<div class="modal" id="prosecutorConfirmModal">
    <div class="modal-content">
        <h2>–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–ø—Ä–∞–≤–∏</h2>
        <div id="caseToDeleteInfo"></div>
        
        <div class="form-group">
            <label for="prosecutorUsername">–õ–æ–≥—ñ–Ω –ø—Ä–æ–∫—É—Ä–æ—Ä–∞:</label>
            <input type="text" id="prosecutorUsername" class="form-control">
        </div>
        
        <div class="form-group">
            <label for="prosecutorPassword">–ü–∞—Ä–æ–ª—å –ø—Ä–æ–∫—É—Ä–æ—Ä–∞:</label>
            <div class="password-wrapper">
                <input type="password" id="prosecutorPassword" class="form-control">
                <button type="button" class="password-toggle" onclick="toggleProsecutorPassword()">üëÅÔ∏è</button>
            </div>
        </div>
        
        <button class="btn btn-danger" onclick="confirmCaseDeletion()" style="width: 100%; margin-bottom: 10px;">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è</button>
        <button class="btn" onclick="closeProsecutorConfirmModal()" style="width: 100%; background: var(--gray);">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>
</div>

<script>
let caseToDelete = null;

function showAddCaseModal() {
    document.getElementById('addCaseModal').style.display = 'flex';
}

function closeAddCaseModal() {
    document.getElementById('addCaseModal').style.display = 'none';
}

function addNewCase() {
    const caseData = {
        number: document.getElementById('caseNumber').value,
        title: document.getElementById('caseTitle').value,
        description: document.getElementById('caseDescription').value,
        category: document.getElementById('caseCategory').value,
        priority: document.getElementById('casePriority').value
    };
    
    if (!caseData.number || !caseData.title) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è!', 'error');
        return;
    }
    
    fetch('/add_case', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(caseData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            closeAddCaseModal();
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    });
}

function viewCase(caseId) {
    fetch(`/view_case/${caseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const caseItem = data.case;
                alert(`–ü–µ—Ä–µ–≥–ª—è–¥ —Å–ø—Ä–∞–≤–∏:\n\n–ù–æ–º–µ—Ä: ${caseItem.number}\n–ù–∞–∑–≤–∞: ${caseItem.title}\n–û–ø–∏—Å: ${caseItem.description}\n–°—Ç–∞—Ç—É—Å: ${caseItem.status}\n–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: ${caseItem.priority}\n–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π: ${caseItem.responsible}`);
            } else {
                showNotification(data.message, 'error');
            }
        });
}

function requestCaseDeletion(caseId) {
    caseToDelete = caseId;
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ–ª–µ
    document.getElementById('caseToDeleteInfo').innerHTML = `
        <p>–í–∏ –¥—ñ–π—Å–Ω–æ –±–∞–∂–∞—î—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–ø—Ä–∞–≤—É ID: ${caseId}?</p>
        <p><strong>–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!</strong></p>
    `;
    
    document.getElementById('prosecutorUsername').value = '';
    document.getElementById('prosecutorPassword').value = '';
    document.getElementById('prosecutorConfirmModal').style.display = 'flex';
}

function closeProsecutorConfirmModal() {
    document.getElementById('prosecutorConfirmModal').style.display = 'none';
    caseToDelete = null;
}

function confirmCaseDeletion() {
    const username = document.getElementById('prosecutorUsername').value;
    const password = document.getElementById('prosecutorPassword').value;
    
    if (!username || !password) {
        showNotification('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å!', 'error');
        return;
    }
    
    fetch('/delete_case', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            case_id: caseToDelete,
            prosecutor_username: username,
            prosecutor_password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            closeProsecutorConfirmModal();
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    });
}

function toggleProsecutorPassword() {
    const passwordInput = document.getElementById('prosecutorPassword');
    const toggleButtons = document.querySelectorAll('.password-toggle');
    const toggleButton = toggleButtons[toggleButtons.length - 1];
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.textContent = 'üîí';
    } else {
        passwordInput.type = 'password';
        toggleButton.textContent = 'üëÅÔ∏è';
    }
}

function logout() {
    window.location.href = '/logout';
}

function filterLogs(filterType, value) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
    console.log(`Filter: ${filterType} = ${value}`);
}

function exportAllLogs() {
    fetch('/admin/export_logs')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('–õ–æ–≥–∏ –≥–æ—Ç–æ–≤—ñ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É', 'success');
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
            }
        });
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
window.onclick = function(event) {
    const modals = ['addCaseModal', 'prosecutorConfirmModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
            if (modalId === 'addCaseModal') closeAddCaseModal();
            if (modalId === 'prosecutorConfirmModal') closeProsecutorConfirmModal();
        }
    });
}

// Enter –¥–ª—è —Ñ–æ—Ä–º
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        if (document.getElementById('addCaseModal').style.display === 'flex') {
            addNewCase();
        }
    }
});
</script>
{% endblock %}
