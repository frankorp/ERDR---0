{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="header">
        <div class="logo">üõ°Ô∏è –Ñ–†–î–† PRO</div>
        <div class="subtitle">–û–±'—î–¥–Ω–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –≤–µ–¥–µ–Ω–Ω—è —Å–ø—Ä–∞–≤ –ø—Ä–∞–≤–æ–æ—Ö–æ—Ä–æ–Ω–Ω–∏—Ö –æ—Ä–≥–∞–Ω—ñ–≤</div>
    </div>

    <div class="agencies-grid">
        <div class="agency-card" onclick="selectAgency('gunp')" style="border-color: var(--gunp);">
            <div class="agency-icon" style="background: var(--gunp);">üëÆ‚Äç‚ôÇÔ∏è</div>
            <div class="agency-name">–ì–£–ù–ü</div>
            <div class="agency-desc">–ì–æ–ª–æ–≤–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ù–∞—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—ó –ø–æ–ª—ñ—Ü—ñ—ó</div>
            <button class="btn" style="background: var(--gunp);">–£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>

        <div class="agency-card" onclick="selectAgency('sbu')" style="border-color: var(--sbu);">
            <div class="agency-icon" style="background: var(--sbu);">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
            <div class="agency-name">–°–ë–£</div>
            <div class="agency-desc">–°–ª—É–∂–±–∞ –ë–µ–∑–ø–µ–∫–∏ –£–∫—Ä–∞—ó–Ω–∏</div>
            <button class="btn" style="background: var(--sbu);">–£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>

        <div class="agency-card" onclick="selectAgency('prosecutor')" style="border-color: var(--prosecutor);">
            <div class="agency-icon" style="background: var(--prosecutor);">‚öñÔ∏è</div>
            <div class="agency-name">–ü—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞</div>
            <div class="agency-desc">–ì–µ–Ω–µ—Ä–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ –£–∫—Ä–∞—ó–Ω–∏</div>
            <button class="btn" style="background: var(--prosecutor);">–£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>

        <div class="agency-card" onclick="selectAgency('admin')" style="border-color: var(--admin);">
            <div class="agency-icon" style="background: var(--admin);">üë®‚Äçüíº</div>
            <div class="agency-name">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</div>
            <div class="agency-desc">–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–∏—Å—Ç–µ–º–∏</div>
            <button class="btn" style="background: var(--admin);">–£–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ -->
<div class="modal" id="loginModal">
    <div class="modal-content">
        <h2 id="modal-agency-name">–ì–£–ù–ü</h2>
        <p id="modal-agency-desc">–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏ –ì–£–ù–ü</p>
        
        <div class="form-group">
            <label for="loginUsername">–õ–æ–≥—ñ–Ω:</label>
            <input type="text" id="loginUsername" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω">
        </div>
        
        <div class="form-group">
            <label for="loginPassword">–ü–∞—Ä–æ–ª—å:</label>
            <div class="password-wrapper">
                <input type="password" id="loginPassword" class="form-control" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å">
                <button type="button" class="password-toggle" onclick="togglePassword()">üëÅÔ∏è</button>
            </div>
        </div>
        
        <button class="btn" onclick="login()" style="width: 100%; margin-bottom: 15px;">–£–≤—ñ–π—Ç–∏</button>
        <button class="btn" onclick="closeLoginModal()" style="width: 100%; background: var(--gray);">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        
        <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
            <h4>–¢–µ—Å—Ç–æ–≤—ñ –ø–∞—Ä–æ–ª—ñ:</h4>
            <div id="passwordList"></div>
        </div>
    </div>
</div>

<script>
let currentAgency = null;

function selectAgency(agency) {
    currentAgency = agency;
    
    fetch(`/select_agency/${agency}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('modal-agency-name').textContent = data.agency.fullName;
                document.getElementById('modal-agency-desc').textContent = `–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏ ${data.agency.name}`;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä–æ–ª–∏
                const passwordList = document.getElementById('passwordList');
                passwordList.innerHTML = data.users.map(user => `
                    <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 4px;">
                        <strong>${user.username}</strong>: ${user.password}
                    </div>
                `).join('');
                
                document.getElementById('loginModal').style.display = 'flex';
            }
        });
}

function closeLoginModal() {
    document.getElementById('loginModal').style.display = 'none';
}

function togglePassword() {
    const passwordInput = document.getElementById('loginPassword');
    const toggleButton = document.querySelector('.password-toggle');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        toggleButton.textContent = 'üîí';
    } else {
        passwordInput.type = 'password';
        toggleButton.textContent = 'üëÅÔ∏è';
    }
}

function login() {
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    fetch('/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            username: username,
            password: password,
            agency: currentAgency
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1000);
        } else {
            showNotification(data.message, 'error');
        }
    });
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
window.onclick = function(event) {
    const modal = document.getElementById('loginModal');
    if (event.target === modal) {
        closeLoginModal();
    }
}

// Enter –¥–ª—è –≤—Ö–æ–¥–∞
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && document.getElementById('loginModal').style.display === 'flex') {
        login();
    }
});
</script>
{% endblock %}
